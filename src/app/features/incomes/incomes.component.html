<div class="container py-3">

  <h2 class="mb-3">Entradas</h2>
  
  <div class="card mb-4" [class.border-warning]="editing">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
          {{ editing ? '‚úèÔ∏è Editando Entrada' : 'Cadastrar nova entrada' }}
        </h4>
        <button *ngIf="editing" class="btn btn-sm btn-secondary" (click)="cancelarEdicao()">
          Cancelar
        </button>
      </div>

      <form [formGroup]="incomeForm" (ngSubmit)="submitForm()" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Descri√ß√£o</label>
          <input class="form-control" formControlName="description">
        </div>
        <div class="col-md-2">
          <label class="form-label">Valor (R$)</label>
          <input class="form-control" type="number" step="0.01" formControlName="amount">
        </div>
        <div class="col-md-2">
          <label class="form-label">Data</label>
          <input class="form-control" type="date" formControlName="date">
        </div>
        <div class="col-md-3">
          <label class="form-label">Tipo de entrada</label>
          <select class="form-select" formControlName="incomeType">
            <option *ngFor="let t of incomeTypes" [value]="t.value">
              {{ t.label }}
            </option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label d-block">Recorrente?</label>
          <input type="checkbox" formControlName="recurring"> Sim
        </div>

        <div class="col-md-3" *ngIf="incomeForm.value.incomeType === 'REEMBOLSO'">
          <label class="form-label">Pessoa (reembolso)</label>
          <input class="form-control" formControlName="personName">
        </div>
        
        <div class="col-md-4"
          *ngIf="incomeForm.value.incomeType === 'REEMBOLSO' && incomeForm.value.parcelaReferenteId">
          <label class="form-label">Parcela vinculada</label>
          <input class="form-control bg-light" [value]="incomeForm.value.parcelaReferenteId" readonly>
          <small class="text-muted">Vinculada a compra espec√≠fica.</small>
        </div>
        <div class="col-md-12">
          <label class="form-label">Observa√ß√µes</label>
          <textarea class="form-control" formControlName="notes"></textarea>
        </div>
        <div class="col-12 text-end">
          <button class="btn" [class.btn-warning]="editing" [class.btn-primary]="!editing" [disabled]="incomeForm.invalid">
            {{ editing ? 'Atualizar' : 'Salvar' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card mb-4 border-warning" *ngIf="reembolsosPendentesMes.length > 0">
    <div class="card-header bg-warning-subtle border-warning">
      <h5 class="mb-0 text-warning-emphasis">‚ö† Reembolsos pendentes deste m√™s</h5>
    </div>
    <div class="card-body p-0">
      <ul class="list-group list-group-flush">
        <li *ngFor="let p of reembolsosPendentesMes"
          class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ p.personName || 'Terceiro' }}</strong> ‚Äî {{ p.description }}
            <span class="badge bg-secondary ms-2">Parcela {{ p.numero }}/{{ p.total }}</span>
          </div>
          <div class="d-flex align-items-center">
            <span class="me-3 fw-bold">{{ p.valor | currency:'BRL' }}</span>
            <button class="btn btn-sm btn-success" (click)="preencherReembolso(p)">Receber</button>
          </div>
        </li>
      </ul>
    </div>
  </div>

  <div class="card mb-5">
    <div class="card-body p-3">

      <div class="p-3 bg-white border-bottom">
        <div class="row g-2 align-items-center">
          <div class="col-md-3">
            <label class="form-label small mb-1 fw-bold">Filtrar M√™s</label>
            <select class="form-select form-select-sm" [(ngModel)]="mesFiltro" (ngModelChange)="onMesFiltroChange()">
              <option *ngFor="let m of mesesDisponiveis" [value]="m">
                {{ formatMonthLabel(m) }}
              </option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label small mb-1 fw-bold">Ordena√ß√£o</label>
            <select class="form-select form-select-sm" [(ngModel)]="sortOrder" (ngModelChange)="processarFiltros()">
              <option value="DATE_DESC">üìÖ Mais Recente</option>
              <option value="DATE_ASC">üìÖ Mais Antiga</option>
              <option value="VAL_DESC">üí≤ Maior Valor</option>
              <option value="VAL_ASC">üí≤ Menor Valor</option>
            </select>
          </div>

          <div class="col-md-6 text-end align-self-end">
            <span class="badge bg-light text-dark border">{{ filteredIncomes.length }} itens (M√™s: {{
              formatMonthLabel(mesFiltro) }})</span>
          </div>
        </div>
      </div>
      <div *ngIf="loading" class="p-3">Carregando‚Ä¶</div>

      <div class="table-responsive">
        <table *ngIf="!loading" class="table table-sm mb-0 align-middle table-hover">
          <thead class="table-light">
            <tr>
              <th>Data</th>
              <th>Descri√ß√£o</th>
              <th>Tipo</th>
              <th>Valor</th>
              <th>Pessoa</th>
              <th>Recorrente</th>
              <th class="text-end">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let i of filteredIncomes" 
                [class.table-warning]="i.id?.startsWith('VIRTUAL-')"
                [class.table-active]="editing?.id === i.id">
              <td>{{ i.date | date:'dd/MM/yyyy' }}</td>
              <td>
                {{ i.description }}
                <span *ngIf="i.id?.startsWith('VIRTUAL-')" class="badge bg-warning text-dark ms-1">Previsto</span>
              </td>
              <td>
                <span class="badge" 
                  [class.bg-info]="i.incomeType === 'REEMBOLSO'"
                  [class.bg-success]="i.incomeType === 'SALARIO'"
                  [class.bg-secondary]="i.incomeType === 'PONTUAL'"
                  [class.bg-primary]="i.incomeType === 'RECORRENTE'">
                  {{ i.incomeType }}
                </span>
              </td>
              <td class="font-monospace fw-bold text-success">{{ i.amount | currency:'BRL' }}</td>
              <td>{{ i.personName || '-' }}</td>
              <td>{{ i.recurring ? 'Sim' : 'N√£o' }}</td>
              <td class="text-end">
                <ng-container *ngIf="i.id?.startsWith('VIRTUAL-'); else botoesNormais">
                  <button class="btn btn-sm btn-success me-2" (click)="confirmarVirtual(i)" title="Confirmar">‚úî</button>
                  <button class="btn btn-sm btn-outline-primary" (click)="iniciarEdicao(i)" title="Editar">‚úèÔ∏è</button>
                </ng-container>
                <ng-template #botoesNormais>
                  <button class="btn btn-sm btn-link text-primary p-0 me-3" (click)="iniciarEdicao(i)" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button class="btn btn-sm btn-link text-danger p-0" (click)="deletar(i.id)" title="Excluir">
                    üóëÔ∏è
                  </button>
                </ng-template>
              </td>
            </tr>
            <tr *ngIf="filteredIncomes.length === 0">
              <td colspan="7" class="text-center text-muted py-4">Nenhuma entrada encontrada para este filtro.</td>
            </tr>
          </tbody>

          <tfoot *ngIf="filteredIncomes.length > 0" class="table-light border-top">
            <tr class="fw-bold">
              <td colspan="3" class="text-end">TOTAL DE ENTRADAS:</td>
              <td class="text-end text-success font-monospace">{{ totalMensal | currency:'BRL' }}</td>
              <td colspan="3" class="text-end">REEMBOLSOS: {{ totalReembolsosMensal | currency:'BRL' }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
      ¬† ¬†
    </div>
    ¬†
  </div>

</div>