<div class="container py-3">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Meus Cart√µes</h2>
    <button class="btn btn-outline-primary" (click)="showCardForm = !showCardForm">
      {{ showCardForm ? 'Cancelar' : 'Novo Cart√£o' }}
    </button>
  </div>

  <div *ngIf="showCardForm" class="card mb-4 border-primary">
    <div class="card-body">
      <h5>{{ editingCard ? 'Editar' : 'Cadastrar' }} Cart√£o</h5>
      <form [formGroup]="cardForm" (ngSubmit)="saveCard()" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Apelido (Ex: Nubank)</label>
          <input class="form-control" formControlName="name">
        </div>
        <div class="col-md-2">
          <label class="form-label">Melhor Dia de Compra</label>
          <input type="number" class="form-control" formControlName="bestPurchaseDay">
        </div>
        <div class="col-md-2">
          <label class="form-label">Dia Vencimento</label>
          <input type="number" class="form-control" formControlName="dueDay">
        </div>
        <div class="col-md-2">
          <label class="form-label">Cor</label>
          <input type="color" class="form-control form-control-color w-100" formControlName="color">
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary" [disabled]="cardForm.invalid">Salvar Cart√£o</button>
        </div>
      </form>
    </div>
  </div>

  <ul class="nav nav-tabs mb-4">
    <li class="nav-item" *ngFor="let c of cards">
      <a 
        class="nav-link" 
        [class.active]="selectedCardId === c.id"
        style="cursor: pointer"
        (click)="selectCard(c.id)">
        <span [style.color]="c.color">‚óè</span> {{ c.name }}
      </a>
    </li>
  </ul>

  <div *ngIf="cards.length === 0 && !loading" class="alert alert-warning">
    Voc√™ ainda n√£o cadastrou nenhum cart√£o.
  </div>

  <div *ngIf="selectedCardId && !loading">
    
    <div class="card mb-4 bg-light">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                {{ editingPurchaseId ? '‚úèÔ∏è Editando Compra' : 'üõí Lan√ßar Nova Compra' }}
            </h5>
            <button *ngIf="editingPurchaseId" class="btn btn-sm btn-secondary" (click)="cancelEditPurchase()">
                Cancelar Edi√ß√£o
            </button>
        </div>

        <form [formGroup]="purchaseForm" (ngSubmit)="savePurchase()" class="row g-3">
          
          <div class="col-md-4">
            <label class="form-label">Descri√ß√£o</label>
            <input class="form-control" formControlName="description" placeholder="Ex: Supermercado">
          </div>
          
          <div class="col-md-2">
            <label class="form-label">Valor Total (R$)</label>
            <input type="number" step="0.01" class="form-control" formControlName="amount">
          </div>

          <div class="col-md-2">
            <label class="form-label">Data da Compra</label>
            <input type="date" class="form-control" formControlName="date">
          </div>

          <div class="col-md-2">
            <label class="form-label">Parcelas</label>
            <input type="number" min="1" class="form-control" formControlName="totalInstallments">
          </div>

          <div class="col-md-2">
            <label class="form-label">Respons√°vel (Opcional)</label>
            <input type="text" class="form-control" formControlName="personName" placeholder="Deixar vazio se for meu">
          </div>

          <div class="col-md-12">
            <label class="form-label">Observa√ß√£o</label>
            <input type="text" class="form-control" formControlName="notes" placeholder="Detalhes adicionais...">
          </div>

          <div class="col-12 text-end">
             <button class="btn" [class.btn-warning]="editingPurchaseId" [class.btn-success]="!editingPurchaseId" [disabled]="purchaseForm.invalid">
                 {{ editingPurchaseId ? 'Atualizar Compra' : 'Lan√ßar Compra' }}
             </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Hist√≥rico de Compras</h5>
            <button class="btn btn-sm btn-outline-secondary" 
              *ngIf="getCardById(selectedCardId) as card"
              (click)="editCard(card)">
              ‚öôÔ∏è Configurar este Cart√£o
            </button>
        </div>

        <div class="row g-2 mb-3 bg-light p-2 rounded align-items-end">
            <div class="col-md-3">
                <label class="form-label small mb-1 fw-bold">Filtrar M√™s</label>
                <select class="form-select form-select-sm" [(ngModel)]="filterMonth">
                    <option value="">Todos os meses</option>
                    <option *ngFor="let m of availableMonths" [value]="m">
                        {{ formatMonthLabel(m) }}
                    </option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-1 fw-bold">Filtrar Respons√°vel</label>
                <select class="form-select form-select-sm" [(ngModel)]="filterPerson">
                    <option value="">Todos</option>
                    <option value="TITULAR">Somente Eu (Titular)</option>
                    <option *ngFor="let p of availablePeople" [value]="p">{{ p }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-1 fw-bold">Ordena√ß√£o</label>
                <select class="form-select form-select-sm" [(ngModel)]="sortOrder">
                    <option value="DATE_DESC">üìÖ Mais Recente</option>
                    <option value="DATE_ASC">üìÖ Mais Antigo</option>
                    <option value="VAL_DESC">üí≤ Maior Valor</option>
                    <option value="VAL_ASC">üí≤ Menor Valor</option>
                </select>
            </div>
            <div class="col-md-3 text-end">
                 <span class="badge bg-secondary">{{ filteredPurchases.length }} compras</span>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Data</th>
                  <th>Descri√ß√£o</th>
                  <th>Parc.</th>
                  <th>Resp.</th>
                  <th>Obs.</th>
                  <th class="text-end">Total</th>
                  <th class="text-end" style="min-width: 100px;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let p of filteredPurchases" [class.table-warning]="editingPurchaseId === p.id">
                  <td>{{ p.date | date:'dd/MM/yy' }}</td>
                  <td>{{ p.description }}</td>
                  <td>{{ p.totalInstallments }}x</td>
                  <td>
                     <span *ngIf="p.personName" class="badge bg-info text-dark">{{ p.personName }}</span>
                     <span *ngIf="!p.personName" class="badge bg-light text-dark border">Eu</span>
                  </td>
                  <td>
                      <span *ngIf="p.notes" [title]="p.notes">üìù</span>
                  </td>
                  <td class="text-end font-monospace">{{ p.amount | currency:'BRL' }}</td>
                  <td class="text-end">
                      <button class="btn btn-sm btn-link text-primary p-0 me-3" (click)="startEditPurchase(p)" title="Editar">
                          ‚úèÔ∏è
                      </button>
                      <button class="btn btn-sm btn-link text-danger p-0" (click)="deletePurchase(p.id)" title="Excluir">
                          üóëÔ∏è
                      </button>
                  </td>
                </tr>
                <tr *ngIf="filteredPurchases.length === 0">
                    <td colspan="7" class="text-center text-muted py-4">
                        Nenhuma compra encontrada com estes filtros.
                    </td>
                </tr>
              </tbody>
              
              <tfoot *ngIf="filteredPurchases.length > 0">
                  <tr class="fw-bold border-top table-light">
                      <td colspan="5" class="text-end">TOTAL COMPRAS (Valor Cheio):</td>
                      <td class="text-end text-primary font-monospace">{{ totalFilteredOriginal | currency:'BRL' }}</td>
                      <td></td>
                  </tr>
                  <tr *ngIf="filterMonth" class="text-muted small">
                      <td colspan="5" class="text-end">Soma das Parcelas (Aprox.):</td>
                      <td class="text-end font-monospace">{{ totalFilteredParcela | currency:'BRL' }}</td>
                      <td></td>
                  </tr>
              </tfoot>
            </table>
        </div>
      </div>
    </div>

  </div>
</div>