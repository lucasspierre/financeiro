<div class="container-fluid py-4 bg-light min-vh-100">

  <!-- CABE√áALHO E FILTRO -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold text-dark m-0">Dashboard</h2>
      <small class="text-muted">Vis√£o geral das suas finan√ßas</small>
    </div>
    
    <div class="d-flex align-items-center bg-white p-2 rounded shadow-sm">
      <label class="me-2 fw-bold text-secondary small mb-0">M√äS:</label>
      <select class="form-select form-select-sm fw-bold border-0 text-primary" 
              style="width: 140px; cursor: pointer;" 
              [(ngModel)]="filterMonth" 
              (change)="atualizarDashboard()">
        <option *ngFor="let m of availableMonths" [value]="m">{{ formatMesLabel(m) }}</option>
      </select>
    </div>
  </div>

  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
  </div>

  <div *ngIf="!loading && snapshot">

    <!-- 1. KPI CARDS -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 border-start border-4 border-success">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="text-uppercase small fw-bold text-muted mb-1">Entradas</div>
                <h3 class="fw-bold text-success mb-0">{{ monthIncomeSum | currency:'BRL' }}</h3>
              </div>
              <div class="text-success opacity-25 fs-2">‚¨ÜÔ∏è</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 border-start border-4 border-danger">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="text-uppercase small fw-bold text-muted mb-1">Despesas</div>
                <h3 class="fw-bold text-danger mb-0">{{ monthExpensesSum | currency:'BRL' }}</h3>
              </div>
              <div class="text-danger opacity-25 fs-2">‚¨áÔ∏è</div>
            </div>
            <div class="mt-2 small text-muted d-flex justify-content-between">
              <span>Cart√£o: {{ totalCartaoMes | currency:'BRL' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 border-start border-4" 
             [ngClass]="saldoMes >= 0 ? 'border-primary' : 'border-warning'">
          <div class="card-body p-3">
             <div class="text-uppercase small fw-bold text-muted mb-1">Saldo Previsto</div>
             <h3 class="fw-bold mb-0" [ngClass]="saldoMes >= 0 ? 'text-primary' : 'text-warning'">
               {{ saldoMes | currency:'BRL' }}
             </h3>
             <div class="mt-2 small text-muted">Ap√≥s pagar contas</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
               <div class="text-uppercase small fw-bold text-muted">Teto Mensal</div>
               <span class="badge" 
                  [class.bg-success]="percentageUsed < 80" 
                  [class.bg-warning]="percentageUsed >= 80"
                  [class.bg-danger]="percentageUsed >= 100">
                  {{ percentageUsed | number:'1.0-0' }}%
               </span>
            </div>
            <div class="progress mb-2" style="height: 8px;">
              <div class="progress-bar" 
                   [class.bg-success]="percentageUsed < 80"
                   [class.bg-warning]="percentageUsed >= 80"
                   [class.bg-danger]="percentageUsed >= 100"
                   [style.width.%]="percentageUsed > 100 ? 100 : percentageUsed">
              </div>
            </div>
            <small class="text-muted">Meta: {{ snapshot.config.monthlyLimit | currency:'BRL' }}</small>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. GR√ÅFICOS -->
    <div class="row g-3 mb-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3">
                    <h6 class="fw-bold m-0 text-secondary">Fluxo de Caixa (Pr√≥ximos 6 Meses)</h6>
                </div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas baseChart
                            [data]="barChartData"
                            [options]="barChartOptions"
                            [type]="barChartType">
                        </canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3">
                    <h6 class="fw-bold m-0 text-secondary">Uso do Cart√£o (Este M√™s)</h6>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <div style="height: 200px; width: 100%;">
                        <canvas baseChart
                            [data]="doughnutChartData"
                            [options]="doughnutChartOptions"
                            [type]="doughnutChartType">
                        </canvas>
                    </div>
                    <div class="mt-3 text-center small text-muted">
                        Total Faturas: <strong class="text-dark">{{ totalCartaoMes | currency:'BRL' }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. TABELAS -->
    <div class="row g-3">
        
        <!-- Contas do M√™s -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold m-0 text-danger">
                        Contas do M√™s ({{ formatMesLabel(filterMonth) }})
                    </h6>
                    <span class="badge bg-light text-dark border">{{ contasDoMes.length }} itens</span>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li *ngFor="let item of contasDoMes" class="list-group-item d-flex justify-content-between align-items-center px-3 py-2 border-bottom-0">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle p-2 me-3 d-flex align-items-center justify-content-center text-white" 
                                     style="width: 40px; height: 40px;"
                                     [class.bg-warning]="item.type === 'FATURA'"
                                     [class.bg-secondary]="item.type === 'CONTA'">
                                    <span *ngIf="item.type === 'FATURA'" class="fs-6">üí≥</span>
                                    <span *ngIf="item.type === 'CONTA'" class="fs-6">üìÑ</span>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark text-truncate" style="max-width: 180px;">{{ item.description }}</div>
                                    <div class="text-muted small">
                                        Venc: {{ item.date | date:'dd/MM' }} ‚Ä¢ {{ item.categoryLabel }}
                                    </div>
                                </div>
                            </div>
                            <div class="fw-bold fs-6 text-dark">
                                {{ item.amount | currency:'BRL' }}
                            </div>
                        </li>
                        
                        <li *ngIf="contasDoMes.length === 0" class="list-group-item text-center text-muted py-5">
                            <p class="mb-0">Nenhuma conta prevista para este m√™s.</p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Proje√ß√£o -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3">
                    <h6 class="fw-bold m-0 text-success">Proje√ß√£o de Entradas (6 Meses)</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle text-center mb-0" style="font-size: 0.85rem;">
                            <thead class="table-light text-secondary text-uppercase">
                                <tr>
                                    <th class="text-start ps-3">Origem</th>
                                    <th *ngFor="let m of mesesFuturosHeader.slice(0, 6)">{{ formatMesLabel(m) }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let linha of entradasFuturasLinhas">
                                    <td class="text-start ps-3 fw-bold text-truncate" style="max-width: 120px;" [title]="linha.description">
                                        <span *ngIf="linha.type === 'TERCEIROS'" class="text-info me-1">‚óè</span>
                                        <span *ngIf="linha.type === 'RECORRENTE'" class="text-success me-1">‚óè</span>
                                        {{ linha.personName ? linha.personName : '' }} {{ linha.description }}
                                    </td>
                                    <td *ngFor="let m of mesesFuturosHeader.slice(0, 6)">
                                        <span [class.text-muted]="!linha.valoresPorMes[m]" [class.fw-bold]="linha.valoresPorMes[m]">
                                            {{ (linha.valoresPorMes[m] || 0) | currency:'BRL':'symbol':'1.0-0' }}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="table-light fw-bold text-success">
                                <tr>
                                    <td class="text-start ps-3">TOTAL</td>
                                    <td *ngFor="let m of mesesFuturosHeader.slice(0, 6)">{{ totaisMesFuturo[m] | currency:'BRL':'symbol':'1.0-0' }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

  </div>
</div>